# BECCA Weekly Summary
# Generates executive-level metrics summary every Monday
#
# Tracks:
# - Scan frequency and performance
# - Profit risk grade distribution (A/B/C/D/F)
# - Secrets findings per week
# - Top recurring cost vectors
# - Week-over-week health trends

name: BECCA Weekly Summary

on:
  schedule:
    # Every Monday at 9:00 AM America/New_York (14:00 UTC)
    - cron: '0 14 * * 1'
  workflow_dispatch:
    inputs:
      weeks:
        description: 'Number of weeks to include'
        required: false
        default: '1'
        type: string

permissions:
  contents: write

env:
  PYTHON_VERSION: '3.11'

jobs:
  generate-summary:
    name: Generate Weekly Summary
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true

      - name: Generate weekly summary
        id: summary
        run: |
          WEEKS="${{ github.event.inputs.weeks || '1' }}"

          python tools/generate_weekly_summary.py \
            --project . \
            --weeks "$WEEKS"

          # Capture key metrics for summary
          if [ -f "governance/metrics/weekly_summary.json" ]; then
            HEALTH_SCORE=$(jq -r '.health_score.score' governance/metrics/weekly_summary.json)
            HEALTH_LABEL=$(jq -r '.health_score.label' governance/metrics/weekly_summary.json)
            TOTAL_SCANS=$(jq -r '.scan_metrics.total_scans' governance/metrics/weekly_summary.json)
            TOTAL_SECRETS=$(jq -r '.secrets.total_findings' governance/metrics/weekly_summary.json)

            echo "health_score=$HEALTH_SCORE" >> $GITHUB_OUTPUT
            echo "health_label=$HEALTH_LABEL" >> $GITHUB_OUTPUT
            echo "total_scans=$TOTAL_SCANS" >> $GITHUB_OUTPUT
            echo "total_secrets=$TOTAL_SECRETS" >> $GITHUB_OUTPUT
          fi

      - name: Commit summary (if meaningful change)
        run: |
          git config user.name "BECCA Bot"
          git config user.email "becca@example.com"

          # Check if there are changes
          if git diff --quiet governance/metrics/; then
            echo "No changes to commit"
            exit 0
          fi

          # Only commit if meaningful change occurred
          # Skip commits when: no scans AND no delta from previous
          TOTAL_SCANS="${{ steps.summary.outputs.total_scans }}"
          if [ "$TOTAL_SCANS" = "0" ]; then
            # Check if health score changed from last commit
            PREV_SCORE=$(git show HEAD:governance/metrics/weekly_summary.json 2>/dev/null | jq -r '.health_score.score' 2>/dev/null || echo "0")
            CURR_SCORE="${{ steps.summary.outputs.health_score }}"

            if [ "$PREV_SCORE" = "$CURR_SCORE" ]; then
              echo "No meaningful change (0 scans, same score) - skipping commit"
              exit 0
            fi
          fi

          git add governance/metrics/

          WEEK_DATE=$(date -u +%Y-%m-%d)
          git commit -m "chore(metrics): weekly summary for week of $WEEK_DATE

          Health Score: ${{ steps.summary.outputs.health_score }}/100 (${{ steps.summary.outputs.health_label }})
          Total Scans: ${{ steps.summary.outputs.total_scans }}
          Secrets Found: ${{ steps.summary.outputs.total_secrets }}

          Generated by BECCA Weekly Summary workflow.

          Co-Authored-By: BECCA Bot <becca@example.com>"

          git push

      - name: Job summary
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          # BECCA Weekly Summary

          | Metric | Value |
          |--------|-------|
          | Health Score | ${{ steps.summary.outputs.health_score }}/100 |
          | Health Label | ${{ steps.summary.outputs.health_label }} |
          | Total Scans | ${{ steps.summary.outputs.total_scans }} |
          | Secrets Found | ${{ steps.summary.outputs.total_secrets }} |

          See `governance/metrics/weekly_summary.json` for full details.
          EOF
